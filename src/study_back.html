<!-- Back Template - Step 2: HTML Skeleton for Ladder Layout -->

<div id="card" class="back">
    <!-- 1. è§†é¢‘å®¹å™¨ -->
    <div class="card__section video-container">
        {{#SentenceVideo}}
        <video
            id="video_back"
            class="video-player"
            src='{{SentenceVideo}}'
            controls
            playsinline
            autoplay
            preload="auto">
            <!-- preload="metadata"> -->
            <!-- muted -->
            <!-- loop -->
        </video>
        {{/SentenceVideo}}
    </div>

    <!-- 2. å¥å­å®¹å™¨ -->
    <div class="card__section sentence-container">
        <div class="sentence-with-audio">
            {{#SentenceAudio}}
            <button id="play_sentence_audio_btn_back" class="audio-button sentence-audio-button" title="Play sentence audio">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M3 9v6h4l5 5V4L7 9H3zm13.5 3c0-1.77-1.02-3.29-2.5-4.03v8.05c1.48-.73 2.5-2.25 2.5-4.02zM14 3.23v2.06c2.89.86 5 3.54 5 6.71s-2.11 5.85-5 6.71v2.06c4.01-.91 7-4.49 7-8.77s-2.99-7.86-7-8.77z"></path></svg>
            </button>
            {{/SentenceAudio}}
            <!-- è¿™é‡Œæ˜¾ç¤ºå¸¦å‡åçš„å¥å­ -->
            <div class="sentence">{{furigana:SentenceReading}}</div>
        </div>

        {{#SentenceMeaning}}
        <div class="sentence-meaning">{{SentenceMeaning}}</div>
        {{/SentenceMeaning}}

        <!-- [æ–°å¢] Note æ˜¾ç¤ºåŒºåŸŸ -->
        {{#Note}}
        <div class="sentence-note">ğŸ’¡ {{Note}}</div>
        {{/Note}}
    </div>

    <hr class="section-divider">

    <!-- 3. å•è¯è¯¦æƒ…å®¹å™¨ -->
    <div class="card__section expression-details">

        <!-- é¡¶éƒ¨ï¼šå•è¯ + éŸ³é¢‘ + å£°è°ƒ + [ç°åœ¨æ ‡ç­¾ä¹Ÿæ”¾åœ¨è¿™é‡Œäº†] -->
        <div class="expression-header-ladder">
            <div class="ladder-item ladder-item__expression">
                <h1 class="expression-main">{{Expression}}</h1>
                {{#ExpressionAudio}}
                <button id="play_expression_audio_btn" class="audio-button" title="Play word audio">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M3 9v6h4l5 5V4L7 9H3zm13.5 3c0-1.77-1.02-3.29-2.5-4.03v8.05c1.48-.73 2.5-2.25 2.5-4.02zM14 3.23v2.06c2.89.86 5 3.54 5 6.71s-2.11 5.85-5 6.71v2.06c4.01-.91 7-4.49 7-8.77s-2.99-7.86-7-8.77z"></path></svg>
                </button>
                {{/ExpressionAudio}}
            </div>
            <!-- 2. å£°è°ƒè¡Œ -->
            <div class="ladder-item ladder-item__pitch">
                <div id="pitch-accent-svg-container"></div>
            </div>
            <!-- 3. [æ¬å®¶åˆ°äº†è¿™é‡Œ] æ ‡ç­¾è¡Œ -->
            <div class="meta-top-right">
                <!-- é¢‘ç‡æ”¾åœ¨æœ€å‰é¢ï¼Œæ˜¾çœ¼ -->
                {{#Frequency}}
                <span class="meta-badge freq-badge">Freq: {{Frequency}}</span>
                {{/Frequency}}

                <!-- æ ‡ç­¾å®¹å™¨ -->
                <div id="tag-display-area" class="tags-group"></div>
                <div id="tag-container" style="display:none;">{{Tags}}</div>
            </div>
        </div>

        <!-- é‡Šä¹‰å®¹å™¨ (åŒ…å«å†…å®¹ ) -->
        <div class="meaning-wrapper">
            <!-- é‡Šä¹‰å†…å®¹ -->
            <div class="meaning-content">
                {{MeaningHTML}}
            </div>
        </div>

    </div>
</div>


<!-- The script remains the same for now, but will be completely replaced in Step 3 -->
<script>
    setTimeout(function() {
        // --- Video Interaction (unchanged) ---
        const backVideo = document.querySelector('#card.back .video-player');
        if (backVideo) {
            backVideo.addEventListener('click', function(event) {
                if (event.target === backVideo) { if (backVideo.paused) { backVideo.play(); } else { backVideo.pause(); } }
            });
        }

        // --- Expression Audio (unchanged) ---
        const expressionAudioBtn = document.getElementById('play_expression_audio_btn');
        const audioFilename = "{{ExpressionAudio}}";
        if (expressionAudioBtn && audioFilename) {
            expressionAudioBtn.addEventListener('click', function() {
                const audio = new Audio(audioFilename);
                audio.play();
            });
        }

        // --- Pitch Accent SVG Generator (Patched Version) ---
        function generatePitchAccentSVG() {
            const container = document.getElementById('pitch-accent-svg-container');
            const kana = "{{Reading}}";
            const pitchData = "{{PitchAccent}}";

            if (!container || !kana || pitchData === "") return;

            const pitchPositions = pitchData.match(/\d+/g);
            if (!pitchPositions) return;

            const groupMoras = (k) => { let morae = []; const smallKana = "ã‚ƒã‚…ã‚‡ããƒã…ã‡ã‰ã‚"; for (let i = 0; i < k.length; i++) { if (i + 1 < k.length && smallKana.includes(k[i+1])) { morae.push(k[i] + k[i+1]); i++; } else { morae.push(k[i]); } } return morae; };
            const getPattern = (pitchPos, morae) => { const len = morae.length; let pattern = []; if (pitchPos == 0) { for (let i = 0; i < len; i++) pattern.push(i === 0 ? 'L' : 'H'); } else if (pitchPos == 1) { for (let i = 0; i < len; i++) pattern.push(i === 0 ? 'H' : 'L'); } else { for (let i = 0; i < len; i++) pattern.push(i > 0 && i < pitchPos ? 'H' : 'L'); } return pattern; };

            const morae = groupMoras(kana);
            const pattern = getPattern(parseInt(pitchPositions[0], 10), morae);

            // --- SVG Generation Logic (with patch) ---

            // *** PATCH STARTS HERE ***
            let fontSize = parseFloat(getComputedStyle(document.documentElement).getPropertyValue('--font-size-l'));
            // Add a fallback: if reading CSS variable fails, use a reasonable default.
            if (isNaN(fontSize) || fontSize <= 0) {
                fontSize = 28; // A sensible default size in pixels
            }
            // *** PATCH ENDS HERE ***

            // [ä¼˜åŒ–ç‰ˆ] åŸºç¡€å®½åº¦ç³»æ•°
            const baseMoraWidth = fontSize * 1.2;

            // è®¡ç®—æ€»å®½åº¦ï¼šå¦‚æœæ˜¯æ‹—éŸ³(é•¿åº¦>1)ï¼Œç»™å®ƒæ›´å¤šç©ºé—´
            let totalWidth = 0;
            let moraPositions = [];

            for (let i = 0; i < morae.length; i++) {
                // å¦‚æœè¿™ä¸ªéŸ³åŒ…å«2ä¸ªå­—ç¬¦(å¦‚ãã‚ƒ)ï¼Œç»™å®ƒ 1.8å€å®½åº¦ï¼Œå¦åˆ™ç»™ 1.2å€
                const currentWidth = (morae[i].length > 1) ? (fontSize * 1.8) : baseMoraWidth;
                // è®°å½•è¿™ä¸ªéŸ³çš„ä¸­å¿ƒç‚¹ä½ç½® (Xåæ ‡)
                moraPositions.push(totalWidth + currentWidth / 2);
                totalWidth += currentWidth;
            }

            const width = totalWidth; // ä½¿ç”¨ç´¯åŠ çš„æ€»å®½åº¦
            const highY = fontSize * 0.5;
            const lowY = fontSize * 1.0;
            const strokeWidth = 2.5;
            const dotRadius = strokeWidth * 1.5;
            const height = fontSize * 2.5;

            // Check for invalid dimensions before rendering
            if (isNaN(width) || width <= 0 || isNaN(height) || height <= 0) {
                console.error("Invalid SVG dimensions calculated.");
                return;
            }

            let svg = `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 ${width} ${height}" width="${width}" height="${height}" style="overflow: visible;">`;

            // 1. Add Kana Text (ä½¿ç”¨è®¡ç®—å¥½çš„ä½ç½®)
            for (let i = 0; i < morae.length; i++) {
                // ä½¿ç”¨ moraPositions[i] ä½œä¸º x åæ ‡
                svg += `<text x="${moraPositions[i]}" y="${height - fontSize * 0.1}" font-size="${fontSize}px" font-family="var(--font-reading)" fill="var(--c-text)" text-anchor="middle">${morae[i]}</text>`;
            }

            // 2. Build Path and Dots (ä½¿ç”¨è®¡ç®—å¥½çš„ä½ç½®)
            let points = [];
            for (let i = 0; i < morae.length; i++) {
                const x = moraPositions[i]; // ä½¿ç”¨æ–°åæ ‡
                const y = pattern[i] === 'H' ? highY : lowY;
                points.push({x, y});
            }

            let pathData = `M ${points[0].x} ${points[0].y}`;
            for (let i = 0; i < points.length - 1; i++) {
                const x_mid = (points[i].x + points[i+1].x) / 2;
                const y_mid = (points[i].y + points[i+1].y) / 2;
                const cp_x1 = (x_mid + points[i].x) / 2;
                const cp_x2 = (x_mid + points[i+1].x) / 2;
                pathData += ` Q ${cp_x1} ${points[i].y}, ${x_mid} ${y_mid}`;
                pathData += ` Q ${cp_x2} ${points[i+1].y}, ${points[i+1].x} ${points[i+1].y}`;
            }

            let dots = "";
            for (let i = 0; i < pattern.length - 1; i++) {
                if (pattern[i] === 'H' && pattern[i+1] === 'L') {
                    dots += `<circle cx="${points[i+1].x}" cy="${points[i+1].y}" r="${dotRadius}" fill="var(--c-pitch-line)" />`;
                }
            }

            svg += `<path d="${pathData}" stroke="var(--c-pitch-line)" stroke-width="${strokeWidth}" fill="none" stroke-linecap="round" stroke-linejoin="round" />`;
            svg += dots;
            svg += `</svg>`;

            container.innerHTML = svg;

        }
        generatePitchAccentSVG();

        // --- (NEW) Sentence Audio Interaction ---
        const sentenceAudioBtnBack = document.getElementById('play_sentence_audio_btn_back');
        const sentenceAudioFilename = "{{SentenceAudio}}"; // Re-declare for clarity, scope is local
        if (sentenceAudioBtnBack && sentenceAudioFilename) {
            sentenceAudioBtnBack.addEventListener('click', function() {
                const audio = new Audio(sentenceAudioFilename);
                audio.play();
            });
        }

        // --- [æ–°å¢] Tags Splitter (æ ‡ç­¾åˆ†å‰²å™¨) ---
        const rawTagContainer = document.getElementById('tag-container');
        const displayArea = document.getElementById('tag-display-area');

        if (rawTagContainer && displayArea) {
            const rawText = rawTagContainer.innerText.trim();
            if (rawText) {
                // æŒ‰ç©ºæ ¼åˆ†å‰²
                const tags = rawText.split(/\s+/);
                let html = '';
                tags.forEach(tag => {
                    // ç”Ÿæˆç‹¬ç«‹çš„å°æ ‡ç­¾
                    html += `<span class="tag-anki">${tag}</span>`;
                });
                displayArea.innerHTML = html;
            }
        }

    }, 0);
</script>